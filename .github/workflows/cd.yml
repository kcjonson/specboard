name: CD

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/workflows/ci.yml'
  workflow_dispatch:

concurrency:
  group: staging-deploy
  cancel-in-progress: true

env:
  AWS_REGION: us-west-2

jobs:
  debounce:
    name: Debounce
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Wait 5 minutes
        run: |
          echo "Waiting 5 minutes to debounce rapid pushes..."
          sleep 300

      - name: Check if still latest commit
        id: check
        run: |
          RESPONSE=$(curl -sf -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/commits/main")

          if [ $? -ne 0 ]; then
            echo "Failed to fetch latest commit, proceeding anyway"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          LATEST=$(echo "$RESPONSE" | jq -r '.sha')

          if [ -z "$LATEST" ] || [ "$LATEST" = "null" ]; then
            echo "Failed to parse SHA, proceeding anyway"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "This commit: ${{ github.sha }}"
          echo "Latest:      $LATEST"

          if [ "${{ github.sha }}" = "$LATEST" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "Newer commits exist, skipping"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  wait-for-ci:
    name: Wait for CI
    runs-on: ubuntu-latest
    needs: debounce
    if: needs.debounce.outputs.should_deploy == 'true'
    steps:
      - name: Wait for CI
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.sha }}
          check-name: 'Build Images'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
          allowed-conclusions: success,skipped

  build-push:
    name: Build and Push
    needs: wait-for-ci
    uses: ./.github/workflows/_build-images.yml
    with:
      push: true
    secrets: inherit

  migrate:
    name: Run Migrations
    needs: build-push
    uses: ./.github/workflows/_run-ecs-task.yml
    with:
      task_name: migrate
      command: '["node", "shared/db/dist/migrate.js"]'
    secrets: inherit

  seed:
    name: Seed Database
    needs: migrate
    uses: ./.github/workflows/_run-ecs-task.yml
    with:
      task_name: seed
      command: '["node", "shared/db/dist/seed.js"]'
      include_admin_env: true
    secrets: inherit

  deploy-infra:
    name: Deploy Infrastructure
    needs: seed
    uses: ./.github/workflows/_deploy-cdk.yml
    with:
      action: deploy
    secrets: inherit

  deploy-services:
    name: Deploy Services
    needs: deploy-infra
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy services
        run: |
          source .github/scripts/get-stack-outputs.sh
          .github/scripts/deploy-services.sh
