name: Production Deploy

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to deploy (e.g., v1.0.0)'
        required: true
        type: string
      bootstrap:
        description: 'Bootstrap mode - create infrastructure only (desiredCount=0, skip service deploy)'
        required: false
        type: boolean
        default: false

concurrency:
  group: production-deploy
  cancel-in-progress: false

env:
  AWS_REGION: us-west-2

jobs:
  resolve:
    name: Resolve Release
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.resolve.outputs.sha }}
      tag: ${{ steps.resolve.outputs.tag }}
    steps:
      - name: Resolve SHA from release
        id: resolve
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
          else
            TAG="${{ inputs.tag }}"
          fi

          SHA=$(curl -sf -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/git/ref/tags/$TAG" \
            | jq -r '.object.sha')

          if [ -z "$SHA" ] || [ "$SHA" = "null" ]; then
            echo "ERROR: Could not resolve SHA for tag $TAG"
            exit 1
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "Deploying tag $TAG (SHA: $SHA)"

  verify-images:
    name: Verify ECR Images
    needs: resolve
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 7200

      - name: Verify images exist for SHA
        run: |
          SHA="${{ needs.resolve.outputs.sha }}"
          MISSING=""

          for REPO in doc-platform/api doc-platform/frontend doc-platform/mcp doc-platform/storage; do
            if ! aws ecr describe-images \
              --repository-name "$REPO" \
              --image-ids imageTag="$SHA" \
              --region "$AWS_REGION" > /dev/null 2>&1; then
              MISSING="$MISSING $REPO"
            fi
          done

          if [ -n "$MISSING" ]; then
            echo "ERROR: Missing images for SHA $SHA:$MISSING"
            echo "Ensure staging CD has deployed this commit before creating a release."
            exit 1
          fi

          echo "All required images verified for SHA $SHA"

  setup-aws:
    name: CDK Deploy Production
    needs: [resolve, verify-images]
    permissions:
      id-token: write
      contents: read
    uses: ./.github/workflows/_deploy-cdk.yml
    with:
      action: deploy
      environment: production
      bootstrap: ${{ inputs.bootstrap || false }}
    secrets: inherit

  migrate:
    name: Run Migrations
    needs: setup-aws
    if: inputs.bootstrap != true
    permissions:
      id-token: write
      contents: read
    uses: ./.github/workflows/_run-ecs-task.yml
    with:
      task_name: migrate
      command: '["node", "shared/db/src/migrate.ts"]'
      environment: production
    secrets: inherit

  deploy-services:
    name: Deploy Services
    needs: [resolve, setup-aws, migrate]
    if: "!cancelled() && inputs.bootstrap != true && needs.setup-aws.result == 'success' && (needs.migrate.result == 'success' || needs.migrate.result == 'skipped')"
    runs-on: ubuntu-latest
    environment: production
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve.outputs.tag }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 7200

      - name: Deploy services
        run: |
          source .github/scripts/get-stack-outputs.sh DocPlatformProd
          .github/scripts/deploy-services.sh "${{ needs.resolve.outputs.sha }}"

  health-check:
    name: Health Check
    needs: deploy-services
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 7200

      - name: Wait and verify health
        run: |
          source .github/scripts/get-stack-outputs.sh DocPlatformProd

          echo "Waiting 30s for services to stabilize..."
          sleep 30

          MAX_RETRIES=5
          RETRY_DELAY=15

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Health check attempt $i/$MAX_RETRIES..."

            API_STATUS=$(curl -sf -o /dev/null -w "%{http_code}" "https://specboard.io/api/health" || echo "000")
            FRONTEND_STATUS=$(curl -sf -o /dev/null -w "%{http_code}" "https://specboard.io/health" || echo "000")

            echo "  API: $API_STATUS, Frontend: $FRONTEND_STATUS"

            if [ "$API_STATUS" = "200" ] && [ "$FRONTEND_STATUS" = "200" ]; then
              echo "Health checks passed!"
              exit 0
            fi

            if [ "$i" -lt "$MAX_RETRIES" ]; then
              echo "  Retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
            fi
          done

          echo "ERROR: Health checks failed after $MAX_RETRIES attempts"
          exit 1

  annotate-release:
    name: Annotate Release
    needs: [resolve, health-check]
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Update release with deploy metadata
        run: |
          TAG="${{ needs.resolve.outputs.tag }}"
          SHA="${{ needs.resolve.outputs.sha }}"
          DEPLOY_TIME="$(date -u '+%Y-%m-%d %H:%M:%S UTC')"

          RELEASE="$(gh api "repos/${{ github.repository }}/releases/tags/$TAG")"
          RELEASE_ID="$(echo "$RELEASE" | jq -r '.id')"
          BODY="$(echo "$RELEASE" | jq -r '.body')"
          DEPLOY_NOTE=$'\n\n---\n**Deployed to production** at '"$DEPLOY_TIME"$'\nSHA: `'"$SHA"'`'

          printf '%s' "$BODY$DEPLOY_NOTE" | jq -Rs '{body:.}' | \
            gh api "repos/${{ github.repository }}/releases/$RELEASE_ID" \
              -X PATCH \
              -H "Content-Type: application/json" \
              --input -
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
