name: Infrastructure

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'CDK action to perform'
        required: true
        default: 'diff'
        type: choice
        options:
          - diff
          - deploy
          - destroy

env:
  AWS_REGION: us-west-2

jobs:
  cdk:
    name: CDK ${{ github.event.inputs.action }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build infrastructure
        run: pnpm --filter @doc-platform/infra build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: CDK Bootstrap (if needed)
        if: github.event.inputs.action == 'deploy'
        run: |
          cd infra
          npx cdk bootstrap aws://${{ secrets.AWS_ACCOUNT_ID }}/${{ env.AWS_REGION }} || true

      - name: CDK Diff
        if: github.event.inputs.action == 'diff'
        run: |
          cd infra
          npx cdk diff

      - name: CDK Deploy
        if: github.event.inputs.action == 'deploy'
        run: |
          cd infra
          npx cdk deploy --require-approval never

      - name: CDK Destroy
        if: github.event.inputs.action == 'destroy'
        run: |
          cd infra
          npx cdk destroy --force

      - name: Output Stack Info
        if: github.event.inputs.action == 'deploy'
        run: |
          aws cloudformation describe-stacks \
            --stack-name DocPlatformStack \
            --query "Stacks[0].Outputs" \
            --output table \
            --region ${{ env.AWS_REGION }}
