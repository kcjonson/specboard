events {
	worker_connections 1024;
}

http {
	# Use Docker's internal DNS resolver with short TTL for dynamic resolution
	resolver 127.0.0.11 valid=10s ipv6=off;
	resolver_timeout 5s;

	server {
		listen 80;

		# Store upstreams in variables to force DNS re-resolution on each request
		set $api_upstream http://api:3001;
		set $frontend_upstream http://frontend:3000;

		# Route /api/* to API service
		location /api/ {
			proxy_pass $api_upstream;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		# Route OAuth API endpoints directly to API service
		# Note: frontend/src/index.ts also has proxy routes for these endpoints,
		# but those are only used in local development (without docker-compose).
		# In docker-compose, nginx routes directly to API for efficiency.
		location /oauth/authorize {
			proxy_pass $api_upstream;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		location /oauth/token {
			proxy_pass $api_upstream;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		location /oauth/revoke {
			proxy_pass $api_upstream;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		# Route .well-known to API service
		location /.well-known/ {
			proxy_pass $api_upstream;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		# Everything else to frontend
		location / {
			proxy_pass $frontend_upstream;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}
	}
}
