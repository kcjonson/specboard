events {
	worker_connections 1024;
}

http {
	# Use Docker's internal DNS resolver with short TTL for dynamic resolution
	resolver 127.0.0.11 valid=10s ipv6=off;
	resolver_timeout 5s;

	# WebSocket upgrade map - sets Connection header based on Upgrade header presence
	map $http_upgrade $connection_upgrade {
		default upgrade;
		'' close;
	}

	server {
		listen 80;

		# Store upstreams in variables to force DNS re-resolution on each request
		set $api_upstream http://api:3001;
		set $frontend_upstream http://frontend:3000;
		set $vite_upstream http://frontend:5173;

		# Route /api/* to API service
		location /api/ {
			proxy_pass $api_upstream;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		# OAuth consent page goes to frontend (SPA)
		location = /oauth/consent {
			proxy_pass $frontend_upstream;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		# All other OAuth endpoints go to API service
		# Includes: /oauth/authorize, /oauth/token, /oauth/revoke, /oauth/register
		location /oauth/ {
			proxy_pass $api_upstream;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		# Route /mcp to MCP service (mirrors ALB routing in staging)
		location /mcp {
			set $mcp_upstream http://mcp:3002;
			proxy_pass $mcp_upstream;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			# SSE support for MCP streaming
			proxy_buffering off;
			proxy_cache off;
			proxy_read_timeout 86400s;
		}

		# Route .well-known to API service
		location /.well-known/ {
			proxy_pass $api_upstream;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		# Vite HMR WebSocket
		location /__vite_hmr {
			proxy_pass $vite_upstream;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection $connection_upgrade;
			proxy_set_header Host $host;
		}

		# Vite dev assets
		location /@vite/ {
			proxy_pass $vite_upstream;
			proxy_set_header Host $host;
		}

		# Vite filesystem route - serves source files for dev.
		# SECURITY: Only for local development. Never expose to public networks.
		location /@fs/ {
			proxy_pass $vite_upstream;
			proxy_set_header Host $host;
		}

		location /.vite/ {
			proxy_pass $vite_upstream;
			proxy_set_header Host $host;
		}

		# Vite source files for HMR.
		# SECURITY: Only for local development. Never expose to public networks.
		location /src/ {
			proxy_pass $vite_upstream;
			proxy_set_header Host $host;
		}

		# Everything else to frontend
		location / {
			proxy_pass $frontend_upstream;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}
	}
}
