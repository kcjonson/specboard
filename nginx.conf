events {
	worker_connections 1024;
}

http {
	# Use Docker's internal DNS resolver with short TTL for dynamic resolution
	resolver 127.0.0.11 valid=10s ipv6=off;
	resolver_timeout 5s;

	# WebSocket upgrade map - sets Connection header based on Upgrade header presence
	map $http_upgrade $connection_upgrade {
		default upgrade;
		'' close;
	}

	server {
		listen 80;

		# Store upstreams in variables to force DNS re-resolution on each request
		set $api_upstream http://api:3001;
		set $frontend_upstream http://frontend:3000;
		set $vite_upstream http://frontend:5173;

		# Route /api/* to API service
		location /api/ {
			proxy_pass $api_upstream;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		# Route OAuth API endpoints directly to API service
		# Note: frontend/src/index.ts also has proxy routes for these endpoints,
		# but those are only used in local development (without docker-compose).
		# In docker-compose, nginx routes directly to API for efficiency.
		location /oauth/authorize {
			proxy_pass $api_upstream;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		location /oauth/token {
			proxy_pass $api_upstream;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		location /oauth/revoke {
			proxy_pass $api_upstream;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		# Route .well-known to API service
		location /.well-known/ {
			proxy_pass $api_upstream;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		# Vite HMR WebSocket
		location /__vite_hmr {
			proxy_pass $vite_upstream;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection $connection_upgrade;
			proxy_set_header Host $host;
		}

		# Vite dev assets
		location /@vite/ {
			proxy_pass $vite_upstream;
			proxy_set_header Host $host;
		}

		# Vite filesystem route - serves source files for dev.
		# SECURITY: Only for local development. Never expose to public networks.
		location /@fs/ {
			proxy_pass $vite_upstream;
			proxy_set_header Host $host;
		}

		location /.vite/ {
			proxy_pass $vite_upstream;
			proxy_set_header Host $host;
		}

		# Vite source files for HMR.
		# SECURITY: Only for local development. Never expose to public networks.
		location /src/ {
			proxy_pass $vite_upstream;
			proxy_set_header Host $host;
		}

		# Everything else to frontend
		location / {
			proxy_pass $frontend_upstream;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}
	}
}
